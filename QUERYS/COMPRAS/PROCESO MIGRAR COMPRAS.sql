

exec MigrarOC '44','2015-10-27','00000137'
exec MigrarOC '44','2015-10-20','00000116'
exec MigrarOC '44','2015-10-27','00000019'
exec MigrarOC '44','2015-10-27','00000018'
exec MigrarOC '44','2015-10-02','00000046'
exec MigrarOC '44','2015-10-02','00000049'
exec MigrarOC '44','2015-10-03','00000050'
exec MigrarOC '44','2015-10-30','00000151'
exec MigrarOC '44','2015-10-13','00000082'
exec MigrarOC '44','2015-10-12','00000076'
exec MigrarOC '44','2015-10-12','00000078'
exec MigrarOC '44','2015-10-13','00000083'
exec MigrarOC '44','2015-10-13','00000084'
exec MigrarOC '44','2015-10-13','00000081'
exec MigrarOC '44','2015-10-14','00000088'
exec MigrarOC '44','2015-10-14','00000087'
exec MigrarOC '44','2015-10-16','00000094'
exec MigrarOC '44','2015-10-16','00000096'
exec MigrarOC '44','2015-10-16','00000095'
exec MigrarOC '44','2015-10-16','00000102'
exec MigrarOC '44','2015-10-17','00000104'
exec MigrarOC '44','2015-10-17','00000105'
exec MigrarOC '44','2015-10-19','00000109'
exec MigrarOC '44','2015-10-19','00000110'
exec MigrarOC '44','2015-10-19','00000113'


exec MigrarOC2 '44','2015-11-10','00000186'
exec MigrarOC2 '43','2015-11-07','00000019'


000052	19-11-15
000019	07-11-15


-----11 noviembre ---
	select id,idAlmacenDestino,DocumentoClienteProveedor ,*FROM SGRPAM.SGRPAM2015.GEN.Movimiento M 
		where numeroCorrelativo = '00000026'
	--	and IdTipoMovimiento='LIM01CEN000000000002' 
        and 
	--	idAlmacenDestino = '43' and fechanegocio = '2015-10-27'  and m.activo =1 

000001	03-11-15	41.8474	11-2015
000002	03-11-15	60.5763	11-2015
000003	03-11-15	241.0169	11-2015
000004	03-11-15	64.9945	11-2015
000005	03-11-15	561.4917	11-2015
000006	03-11-15	349.1529	11-2015
000007	03-11-15	101.695	11-2015
000016	04-11-15	21.3559	11-2015
use [amcaf2015app]
go

exec MigrarOC2 '43','2015-11-03','00000001'
exec MigrarOC2 '43','2015-11-03','00000002'
exec MigrarOC2 '43','2015-11-03','00000003'
exec MigrarOC2 '43','2015-11-03','00000004'
exec MigrarOC2 '43','2015-11-03','00000005'
exec MigrarOC2 '43','2015-11-03','00000006'
exec MigrarOC2 '43','2015-11-03','00000007'
exec MigrarOC2 '43','2015-11-04','00000016'

exec MigrarOC2 '44','2015-10-27','00000026'
exec MigrarOC2 '44','2015-10-27','00000027'
exec MigrarOC '44','2015-10-06','00000053'
exec MigrarOC '44','2015-10-06','00000054'
exec MigrarOC '44','2015-10-06','00000055'
exec MigrarOC '44','2015-10-07','00000056'
exec MigrarOC '44','2015-10-09','00000059'
exec MigrarOC '44','2015-10-10','00000064'
exec MigrarOC '44','2015-10-10','00000065'
exec MigrarOC '44','2015-10-11','00000071'
exec MigrarOC '44','2015-10-12','00000076'
exec MigrarOC '44','2015-10-12','00000078'
exec MigrarOC '44','2015-10-13','00000081'
exec MigrarOC '44','2015-10-13','00000082'
exec MigrarOC '44','2015-10-13','00000083'
exec MigrarOC '44','2015-10-13','00000085'
exec MigrarOC '44','2015-10-14','00000087'
exec MigrarOC '44','2015-10-14','00000088'
exec MigrarOC '44','2015-10-15','00000092'
exec MigrarOC '44','2015-10-16','00000094'
exec MigrarOC '44','2015-10-16','00000095'
exec MigrarOC '44','2015-10-16','00000096'
exec MigrarOC '44','2015-10-16','00000100'
exec MigrarOC '44','2015-10-16','00000102'
exec MigrarOC '44','2015-10-17','00000104'
exec MigrarOC '44','2015-10-17','00000105'
exec MigrarOC '44','2015-10-19','00000109'
exec MigrarOC '44','2015-10-19','00000110'
exec MigrarOC '44','2015-10-19','00000113'
exec MigrarOC '44','2015-10-24','00000126'
exec MigrarOC '44','2015-10-25','00000129'
exec MigrarOC '44','2015-10-26','00000130'
exec MigrarOC '44','2015-10-26','00000132'
exec MigrarOC '44','2015-10-26','00000133'
exec MigrarOC '44','2015-10-26','00000134'
exec MigrarOC '44','2015-10-27','00000139'
exec MigrarOC '44','2015-10-27','00000140'
exec MigrarOC '44','2015-10-27','00000141'
exec MigrarOC '44','2015-10-28','00000144'
exec MigrarOC '44','2015-10-29','00000147'
exec MigrarOC '44','2015-10-29','00000148'
exec MigrarOC '44','2015-10-30','00000153'
exec MigrarOC '44','2015-10-31','00000155'
exec MigrarOC '44','2015-10-31','00000156'
exec MigrarOC '44','2015-10-31','00000157'
exec MigrarOC '44','2015-10-31','00000158'
exec MigrarOC '44','2015-10-31','00000159'


--////////////////////////////////
exec MigrarOC2 '44','2015-10-31','00000159'
exec MigrarOC2 '44','2015-10-30','00000153'
exec MigrarOC2 '44','2015-11-03','00000163'
exec MigrarOC2 '43','2015-11-03','00000015'
exec MigrarOC2 '44','2015-11-03','00000162'
exec MigrarOC2 '44','2015-11-09','00000030'
exec MigrarOC2 '43','2015-11-03','00000013'
exec MigrarOC2 '43','2015-11-04','00000017'
exec MigrarOC2 '43','2015-11-03','00000162'
exec MigrarOC2 '44','2015-11-03','00000034'
exec MigrarOC2 '44','2015-11-09','00000183'
exec MigrarOC2 '44','2015-11-09','00000042'
exec MigrarOC2 '44','2015-11-09','00000041'
exec MigrarOC2 '44','2015-11-09','00000044'
exec MigrarOC2 '44','2015-11-09','00000046'
exec MigrarOC2 '43','2015-11-09','00000031'
exec MigrarOC2 '43','2015-11-10','00000186'
exec MigrarOC2 '44','2015-11-06','00000172'


----------------------
exec MigrarOC '43','2015-11-03','00000008'
exec MigrarOC '43','2015-11-03','00000009'
exec MigrarOC '43','2015-11-03','00000010'
exec MigrarOC '43','2015-11-05','00000018'
exec MigrarOC '43','2015-11-08','00000020'
exec MigrarOC '44','2015-11-11','00000187'
exec MigrarOC '43','2015-11-10','00000021'
exec MigrarOC '44','2015-11-09','00000181'
exec MigrarOC '44','2015-11-09','00000182'
exec MigrarOC '44','2015-11-09','00000180'
exec MigrarOC '44','2015-11-04','00000168'
exec MigrarOC '44','2015-11-04','00000167'
exec MigrarOC '44','2015-11-04','00000166'
exec MigrarOC '44','2015-11-06','00000173'
exec MigrarOC '44','2015-11-06','00000174'
exec MigrarOC '43','2015-11-11','00000022'
exec MigrarOC '44','2015-09-25','00000009'
exec MigrarOC '44','2015-09-25','00000010'




exec MigrarOC2 '43','2015-11-12','00000052'

--
exec MigrarOC2 '44','2015-11-01','00000161'
exec MigrarOC2 '44','2015-11-01','00000160'
exec MigrarOC2 '43','2015-09-25','00000007'
exec MigrarOC2 '44','2015-11-03','00000164'
exec MigrarOC2 '44','2015-11-04','00000165'
exec MigrarOC2 '44','2015-11-05','00000170'
exec MigrarOC2 '44','2015-11-07','00000178'
exec MigrarOC2 '44','2015-11-07','00000179'
exec MigrarOC2 '44','2015-11-07','00000177'
exec MigrarOC2 '44','2015-11-07','00000175'
exec MigrarOC2 '44','2015-11-07','00000176'
exec MigrarOC2 '44','2015-11-11','00000189'
exec MigrarOC2 '44','2015-11-11','00000190'
exec MigrarOC2 '44','2015-11-11','00000191'
exec MigrarOC2 '44','2015-11-11','00000188'
exec MigrarOC2 '44','2015-11-10','00000185'
exec MigrarOC2 '44','2015-11-12','00000192'
exec MigrarOC2 '44','2015-11-14','00000195'
exec MigrarOC2 '44','2015-11-15','00000199'
exec MigrarOC2 '44','2015-11-16','00000200'
exec MigrarOC2 '44','2015-11-17','00000201'
exec MigrarOC2 '44','2015-11-18','00000202'
exec MigrarOC2 '43','2015-11-19','00000204'
exec MigrarOC2 '43','2015-11-03','00000014'
exec MigrarOC2 '43','2015-11-11','00000025'
exec MigrarOC2 '43','2015-11-11','00000023'
exec MigrarOC2 '43','2015-11-11','00000024'
exec MigrarOC2 '43','2015-11-16','00000028'

--
exec MigrarOC2 '43','2015-11-10','00000050'

---------------
 exec MigrarOC2 '43','2015-11-13','00000026'
exec MigrarOC2 '44','2015-11-13', '00000193'




use [amcaf2015sys]
go
select* from screen where number like 'IMP01%'




sp_helptext MigrarOC
LIM01CEN000000000049

ALTER proc MigrarOC
@identificador int,
@fechaNegocio as datetime,
@numero char (10)
as

declare @LastPONbr char(6)
declare @CostoExtendido decimal(16,2)
--declare @identificador int 
declare @siteid char(15)

declare @idlocal char(20)

set @idlocal = (select id from SGRPAM.SGRPAM2015.gen.local where identificador = @identificador )


		declare @idmnov varchar(20)
		declare @idAlmacenDestino varchar(20)
		declare @DocumentoCliente varchar(15)
		DECLARE Cur1 CURSOR FOR 
		select id,idAlmacenDestino,DocumentoClienteProveedor FROM SGRPAM.SGRPAM2015.GEN.Movimiento M 
		where numeroCorrelativo = @numero
		and IdTipoMovimiento='LIM01CEN000000000002' and 
		idAlmacenDestino = @idlocal OR idAlmacenDestino='LIM01CEN000000000049'
        and fechanegocio = @fechaNegocio  and m.activo =1 
		--and DocumentoClienteProveedor ='20450752496'
		AND m.ID collate Modern_Spanish_CI_AS  NOT IN (select user1 from PurchOrd )  
		OPEN Cur1
		FETCH NEXT FROM Cur1 INTO @idmnov,@idAlmacenDestino,@DocumentoCliente
		WHILE ( @@fetch_status <> -1 )
		BEGIN

set @LastPONbr = (select LastPONbr+1 from posetup)
--select @LastPONbr
set @LastPONbr = right('0000'+ rtrim(@LastPONbr),6)
--select @LastPONbr


set @CostoExtendido= (select sum(CostoExtendido) FROM SGRPAM.SGRPAM2015.GEN.DetalleMovimiento where idmovimiento = @idmnov and activo =1)
set @identificador = (select identificador from SGRPAM.SGRPAM2015.gen.local where id = @idAlmacenDestino )
set @siteid = (select siteid from cf_tiendasite where numtienda = @identificador)


if ( select count(*)from vendor where vendid = rtrim(@DocumentoCliente))=0
BEGIN

	insert into vendor (Addr1, Addr2, APAcct, APSub, Attn, BkupWthld, City, ClassID, ContTwc1099, Country, Crtd_DateTime, Crtd_Prog, Crtd_User, Curr1099Yr, 
	CuryId, CuryRateType, DfltBox, DfltOrdFromId, DfltPurchaseType, DirectDeposit, EMailAddr, ExpAcct, ExpSub, Fax, LUpd_DateTime, LUpd_Prog, LUpd_User, 
	MultiChk, Name, Next1099Yr, NoteID, PayDateDflt, PerNbr, Phone, PmtMethod, PPayAcct, PPaySub, RcptPctAct, RcptPctMax, RcptPctMin, RemitAddr1, RemitAddr2, 
	RemitAttn, RemitCity, RemitCountry, RemitFax, RemitName, RemitPhone, RemitSalut, RemitState, RemitZip, S4Future01, S4Future02, S4Future03, S4Future04, 
	S4Future05, S4Future06, S4Future07, S4Future08, S4Future09, S4Future10, S4Future11, S4Future12, Salut, State, Status, TaxDflt, TaxId00, TaxId01, TaxId02, 
	TaxId03, TaxLocId, TaxPost, TaxRegNbr, Terms, TIN, User1, User2, User3, User4, User5, User6, User7, User8, Vend1099, VendId, Zip)

	select distinct 
	Addr1='', Addr2='', APAcct='421213', APSub='0000000RE000', Attn='', BkupWthld=0, City='', ClassID='42130', ContTwc1099=0, Country='PE', 
	Crtd_DateTime= getdate(), Crtd_Prog='03270', Crtd_User='SYSADMIN', Curr1099Yr='2015', CuryId='SOL', CuryRateType='', DfltBox='', DfltOrdFromId='DEFAULT', 
	DfltPurchaseType='GI', DirectDeposit='', EMailAddr='', ExpAcct='949403', ExpSub='0000000RE000', Fax='', LUpd_DateTime=getdate(), LUpd_Prog='03270', 
	LUpd_User='SYSADMIN', MultiChk=0, Name=left(RazonSocial,30), Next1099Yr='2015', NoteID=0, PayDateDflt=0, PerNbr='201509', Phone='', PmtMethod='C', 
	PPayAcct='422101', PPaySub='0000000RE000', RcptPctAct='N', RcptPctMax=0, RcptPctMin=0, RemitAddr1='', RemitAddr2='', RemitAttn='', RemitCity='', 
	RemitCountry='', RemitFax='', RemitName=left(RazonSocial,30), RemitPhone='', RemitSalut='', RemitState='', RemitZip='', S4Future01='', 
	S4Future02='', S4Future03=0, S4Future04=0, S4Future05=0, S4Future06=0, S4Future07='1900-01-01 00:00:00', S4Future08='1900-01-01 00:00:00', 
	S4Future09=0, S4Future10=0, S4Future11='', S4Future12='', Salut='', State='', Status='A', TaxDflt='V', TaxId00='IGV1', TaxId01='', TaxId02='', TaxId03='', 
	TaxLocId='', TaxPost='', TaxRegNbr=Ruc, Terms='01', TIN='', User1=left(RazonSocial,30), 
	User2=replace(RazonSocial,left(RazonSocial,30),''), User3=0, User4=0, User5='', User6='', User7='1900-01-01 00:00:00', 
	User8='1900-01-01 00:00:00', Vend1099=0, VendId=Ruc, Zip=''
	FROM 
	(SGRPAM.SGRPAM2015.com.proveedor P 
	inner join SGRPAM.SGRPAM2015.gen.empresa E  on P.IdPersonaEmpresa = E.id )
	--left join SGRPAM.SGRPAM2015.GEN.Direccion D on D.idEmpresa = P.IdPersonaEmpresa 
	where P.activo =1 and E.activo =1  AND RUC = @DocumentoCliente


	insert into dbo.POAddress (Addr1, Addr2, Attn, City, Country, Crtd_DateTime, Crtd_Prog, Crtd_User, Descr, Fax, LUpd_DateTime, LUpd_Prog, LUpd_User, Name, 
	NoteID, OrdFromId, Phone, S4Future01, S4Future02, S4Future03, S4Future04, S4Future05, S4Future06, S4Future07, S4Future08, S4Future09, S4Future10, S4Future11, 
	S4Future12, State, TaxId00, TaxId01, TaxId02, TaxId03, TaxLocId, TaxRegNbr, User1, User2, User3, User4, User5, User6, User7, User8, VendId, Zip)

	select distinct Addr1=isnull(left( (select direccionCompleta from SGRPAM.SGRPAM2015.GEN.Direccion D where P.IdPersonaEmpresa = D.idEmpresa ) ,30),''), 
	Addr2=isnull(replace((select direccionCompleta from SGRPAM.SGRPAM2015.GEN.Direccion D where  P.IdPersonaEmpresa = D.idEmpresa ),left((select direccionCompleta from SGRPAM.SGRPAM2015.GEN.Direccion D where P.IdPersonaEmpresa = D.idEmpresa ),30),''),''), At
tn='', City='', Country='PE', 
	Crtd_DateTime=getdate(), Crtd_Prog='', Crtd_User='SYSADMIN', Descr=RazonSocial, Fax='', LUpd_DateTime=getdate(), LUpd_Prog='', LUpd_User='SYSADMIN  ', 
	Name=RazonSocial, NoteID=0, OrdFromId='DEFAULT', Phone='', S4Future01='', S4Future02='', S4Future03=0, S4Future04=0, S4Future05=0, S4Future06=0, 
	S4Future07='1900-01-01 00:00:00', S4Future08='1900-01-01 00:00:00', S4Future09=0, S4Future10=0, S4Future11='', S4Future12='', State='', TaxId00='', 
	TaxId01='', TaxId02='', TaxId03='', TaxLocId='', TaxRegNbr='', User1='', User2='', User3=0, User4=0, User5='', User6='', User7='1900-01-01 00:00:00', 
	User8='1900-01-01 00:00:00', VendId=ruc, Zip=''
	FROM 
	SGRPAM.SGRPAM2015.com.proveedor P 
	inner join SGRPAM.SGRPAM2015.gen.empresa E  on P.IdPersonaEmpresa = E.id 
	--inner join SGRPAM.SGRPAM2015.GEN.Direccion D on P.IdPersonaEmpresa = D.idEmpresa
	where P.activo =1 and E.activo =1  AND RUC = @DocumentoCliente

END



BEGIN TRANSACTION -- O solo BEGIN TRAN

BEGIN TRY

insert into dbo.PurchOrd (AckDateTime, BatNbr, BillShipAddr, BlktExprDate, BlktPONbr, Buyer, CertCompl, ConfirmTo, CpnyID, Crtd_DateTime, Crtd_Prog, Crtd_User,
 CurrentNbr, CuryEffDate, CuryFreight, CuryId, CuryMultDiv, CuryPOAmt, CuryPOItemTotal, CuryRate, CuryRateType, CuryRcptTotAmt, CuryTaxTot00, CuryTaxTot01, 
 CuryTaxTot02, CuryTaxTot03, CuryTxblTot00, CuryTxblTot01, CuryTxblTot02, CuryTxblTot03, EDI, FOB, Freight, LastRcptDate, LineCntr, LUpd_DateTime, LUpd_Prog, 
 LUpd_User, NoteID, OpenPO, PC_Status, PerClosed, PerEnt, POAmt, PODate, POItemTotal, PONbr, POType, ProjectID, PrtBatNbr, PrtFlg, RcptStage, RcptTotAmt, 
 ReqNbr, S4Future01, S4Future02, S4Future03, S4Future04, S4Future05, S4Future06, S4Future07, S4Future08, S4Future09, S4Future10, S4Future11, S4Future12, 
 ShipAddr1, ShipAddr2, ShipAddrID, ShipAttn, ShipCity, ShipCountry, ShipEmail, ShipFax, ShipName, ShipPhone, ShipState, ShipVia, ShipZip, Status, TaxCntr00, 
 TaxCntr01, TaxCntr02, TaxCntr03, TaxID00, TaxID01, TaxID02, TaxID03, TaxTot00, TaxTot01, TaxTot02, TaxTot03, Terms, TxblTot00, TxblTot01, TxblTot02, 
 TxblTot03, User1, User2, User3, User4, User5, User6, User7, User8, VendAddr1, VendAddr2, VendAddrID, VendAttn, VendCity, VendCountry, VendEmail, VendFax, 
 VendId, VendName, VendPhone, VendState, VendZip, VouchStage)

SELECT 
AckDateTime='1900-01-01 00:00:00', BatNbr='', BillShipAddr=0, BlktExprDate='1900-01-01 00:00:00', BlktPONbr='', Buyer='RUBEN', 
CertCompl=0, ConfirmTo='', CpnyID='ALTOMAYO  ', Crtd_DateTime=FECHA, Crtd_Prog='04250', Crtd_User='SYSADMIN', CurrentNbr='', CuryEffDate=FECHA, 
CuryFreight=0, CuryId=(SELECT NombreCorto  FROM SGRPAM.SGRPAM2015.GEN.Moneda WHERE ID = idmoneda), CuryMultDiv='M', CuryPOAmt=@CostoExtendido, CuryPOItemTotal=0, CuryRate=1, 
CuryRateType='VENTA', CuryRcptTotAmt=0, CuryTaxTot00=0, CuryTaxTot01=0, CuryTaxTot02=0, CuryTaxTot03=0, CuryTxblTot00=0, CuryTxblTot01=0, CuryTxblTot02=0,
CuryTxblTot03=0, EDI=0, FOB='', Freight=0, LastRcptDate='1900-01-01 00:00:00', LineCntr=0, LUpd_DateTime=fechamodifica, LUpd_Prog='04250', LUpd_User='SYSADMIN', 
NoteID=0, OpenPO=0, PC_Status='', PerClosed='', PerEnt=periodo, POAmt=@CostoExtendido, PODate=fecha, POItemTotal=0, PONbr=@LastPONbr, POType='OR', ProjectID='', PrtBatNbr='', 
PrtFlg=0, RcptStage='N', RcptTotAmt=0, ReqNbr='', S4Future01='', S4Future02='', S4Future03=0, S4Future04=0, S4Future05=0, S4Future06=0, S4Future07='1900-01-01 00:00:00', 
S4Future08='1900-01-01 00:00:00', S4Future09=0, S4Future10=0, S4Future11='', S4Future12='', ShipAddr1=left('',30), 
ShipAddr2=replace('',left('',30),''), ShipAddrID='', ShipAttn='', ShipCity='', ShipCountry='PE', ShipEmail='', ShipFax='', ShipName='ALTOMAYO PERU SAC', ShipPhone='', ShipState='', 
ShipVia='', ShipZip='', Status='O', TaxCntr00=0, TaxCntr01=0, TaxCntr02=0, TaxCntr03=0, TaxID00='IGV1', TaxID01='', TaxID02='', TaxID03='', TaxTot00=0, 
TaxTot01=0, TaxTot02=0, TaxTot03=0, Terms=(select Abreviatura  from SGRPAM.SGRPAM2015.GEN.PagoCondicion where id = CondicionPago), TxblTot00=0, TxblTot01=0, TxblTot02=0, 
TxblTot03=0, User1=@idmnov, User2='', User3=0, User4=0, User5='', User6='', User7='1900-01-01 00:00:00', User8='1900-01-01 00:00:00', 
VendAddr1='', VendAddr2='', VendAddrID='DEFAULT', VendAttn='', VendCity='', 
VendCountry='', VendEmail='', VendFax='', VendId=DocumentoClienteProveedor, VendName=left(NombreClienteProveedor,30), VendPhone='', VendState='', VendZip='', VouchStage=''
FROM SGRPAM.SGRPAM2015.GEN.Movimiento M  --inner join SGRPAM.SGRPAM2015.GEN.Direccion  D on M.IdDireccionFactura = D.id
where m.id =@idmnov and m.activo =1


--select *from PurOrdDet where PONbr=''

insert into dbo.PurOrdDet(AddlCostPct, AllocCntr, AlternateID, AltIDType, BlktLineId, BlktLineRef, Buyer, CnvFact, CostReceived, CostReturned, CostVouched, 
Crtd_DateTime, Crtd_Prog, Crtd_User, CuryCostReceived, CuryCostReturned, CuryCostVouched, CuryExtCost, CuryId, CuryMultDiv, CuryRate, CuryTaxAmt00, 
CuryTaxAmt01, CuryTaxAmt02, CuryTaxAmt03, CuryTxblAmt00, CuryTxblAmt01, CuryTxblAmt02, CuryTxblAmt03, CuryUnitCost, ExtCost, ExtWeight, InvtID, KitUnExpld, 
Labor_Class_Cd, LineID, LineNbr, LineRef, LUpd_DateTime, LUpd_Prog, LUpd_User, NoteID, OpenLine, OrigPOLine, PC_Flag, PC_ID, PC_Status, PONbr, POType, 
ProjectID, PromDate, PurAcct, PurchaseType, PurchUnit, PurSub, QtyOrd, QtyRcvd, QtyReturned, QtyVouched, RcptPctAct, RcptPctMax, RcptPctMin, RcptStage, 
ReasonCd, ReqdDate, ReqNbr, S4Future01, S4Future02, S4Future03, S4Future04, S4Future05, S4Future06, S4Future07, S4Future08, S4Future09, S4Future10, S4Future11, 
S4Future12, ShipAddr1, ShipAddr2, ShipAddrID, ShipCity, ShipCountry, ShipName, ShipState, ShipViaID, ShipZip, SiteId, SOLineRef, SOOrdNbr, SOSchedRef, StepNbr, 
TaskID, TaxAmt00, TaxAmt01, TaxAmt02, TaxAmt03, TaxCalced, TaxCat, TaxID00, TaxID01, TaxID02, TaxID03, TaxIdDflt, TranDesc, TxblAmt00, TxblAmt01, TxblAmt02, 
TxblAmt03, UnitCost, UnitMultDiv, UnitWeight, User1, User2, User3, User4, User5, User6, User7, User8, VouchStage, WOBOMSeq, WOCostType, WONbr, WOStepNbr)
SELECT 
AddlCostPct=0, AllocCntr=0, AlternateID='', AltIDType='', BlktLineId=0, BlktLineRef='', Buyer='', CnvFact=1, CostReceived=0, CostReturned=0, CostVouched=0, 
Crtd_DateTime=d.fechacrea, Crtd_Prog='04250', Crtd_User='SYSADMIN', CuryCostReceived=0, CuryCostReturned=0, CuryCostVouched=0, CuryExtCost=CostoExtendido, 
CuryId='SOL', CuryMultDiv='M', CuryRate=1, CuryTaxAmt00=0, CuryTaxAmt01=0, CuryTaxAmt02=0, CuryTaxAmt03=0, CuryTxblAmt00=0, CuryTxblAmt01=0, CuryTxblAmt02=0, 
CuryTxblAmt03=0, CuryUnitCost= CostoUnitario, ExtCost=CostoExtendido, ExtWeight=0, InvtID= 'I'+P.codigoProducto, KitUnExpld=0, Labor_Class_Cd='', LineID=ROW_NUMBER() OVER(ORDER BY codigoProducto DESC), LineNbr=ROW_NUMBER() OVER(ORDER BY codigoProducto DE
SC), 
LineRef=right('0000'+ltrim(ROW_NUMBER() OVER(ORDER BY codigoProducto DESC)),5), LUpd_DateTime=d.fechacrea, LUpd_Prog='04250', LUpd_User='SYSADMIN', NoteID=0, OpenLine=1, OrigPOLine=1, PC_Flag='Y', PC_ID='', PC_Status='O', 
PONbr=@LastPONbr, POType='OR', ProjectID='', PromDate=FECHAprometida, PurAcct=InvtAcct, PurchaseType='GI', PurchUnit=(select Abreviatura  from SGRPAM.SGRPAM2015.GEN.UnidadMedida where id = idUnidadMedida), 
PurSub=InvtSub, QtyOrd= Cantidad, QtyRcvd=0, QtyReturned=0, QtyVouched=0, RcptPctAct='N', RcptPctMax=100, RcptPctMin=100, RcptStage='N', ReasonCd='', 
ReqdDate= fechaRequerida, ReqNbr='', S4Future01='', S4Future02='', S4Future03=0, S4Future04=0, S4Future05=0, S4Future06=0, S4Future07='1900-01-01 00:00:00', 
S4Future08='1900-01-01 00:00:00', S4Future09=0, S4Future10=0, S4Future11='', S4Future12='', ShipAddr1='', ShipAddr2='', ShipAddrID='', ShipCity='', 
ShipCountry='', ShipName='', ShipState='', ShipViaID='', ShipZip='', SiteId=@siteid, SOLineRef='', SOOrdNbr='', SOSchedRef='', StepNbr=0, TaskID='', 
TaxAmt00=0, TaxAmt01=0, TaxAmt02=0, TaxAmt03=0, TaxCalced='', TaxCat=(case when afecto =1 then 'AFECTO' else 'INAFECTO' end), TaxID00='IGV1', TaxID01='', 
TaxID02='', TaxID03='', TaxIdDflt='', TranDesc=left(DESCRIPCION,60), TxblAmt00=0, TxblAmt01=0, TxblAmt02=0, TxblAmt03=0, UnitCost=CostoUnitario, 
UnitMultDiv='M', UnitWeight=0, User1=@idmnov, User2='', User3=0, User4=0, User5='', User6='', User7='1900-01-01 00:00:00', User8='1900-01-01 00:00:00', 
VouchStage='N', WOBOMSeq=0, WOCostType='', WONbr='', WOStepNbr=0

FROM SGRPAM.SGRPAM2015.GEN.DetalleMovimiento D
inner join SGRPAM.SGRPAM2015.GEN.Producto P on D.idproducto = P.id
inner join inventory I on 'I'+P.codigoProducto = I.invtid collate Modern_Spanish_CI_AS 
where idmovimiento = @idmnov and d.activo =1

update posetup set  LastPONbr =@LastPONbr  from posetup

PRINT 'Se genero con exito'
COMMIT TRANSACTION -- O solo COMMIT

END TRY

BEGIN CATCH

/* Hay un error, deshacemos los cambios*/ 

ROLLBACK TRANSACTION -- O solo ROLLBACK

PRINT 'Se ha producido un error!'
print @@error

END CATCH

			FETCH NEXT FROM Cur1 INTO @idmnov,@idAlmacenDestino,@DocumentoCliente
		END

		CLOSE Cur1

		DEALLOCATE Cur1


END