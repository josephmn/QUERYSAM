-- ALTOMAYO WEB (AM2021APP)
-- BD MASTER

-- PERSONAL ANTIGUO Y NO CESADO

insert into AM2022APP..LIQUIDACION_UTILIDADES_2020
(RUC, RAZON, PERID, FINGRESO, FCESE, ANHIO, PERIODO)

SELECT '20394862704', 'VERDUM PERÚ SAC', DNI, FINGRESO_ORIG, CESE, '2021', '202204' FROM (

SELECT J.DNI, NOMBRE, --FINGRESO, 
FINGRESO_ORIG, CESE,

J.ENERO		 DIAS_ENERO		   , ISNULL(T.DIF_ENE,0) DIF_ENE, (CASE WHEN (J.ENERO		- ISNULL(T.DIF_ENE,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202101'+'01'AS DATETIME))-1),CAST('202101'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.ENERO			- ISNULL(T.DIF_ENE,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202101'+'01'AS DATETIME))-1),CAST('202101'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120)))) END) ENERO,
J.FEBRERO	 DIAS_FEBRERO	   , ISNULL(T.DIF_FEB,0) DIF_FEB, (CASE WHEN (J.FEBRERO		- ISNULL(T.DIF_FEB,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202102'+'01'AS DATETIME))-1),CAST('202102'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.FEBRERO		- ISNULL(T.DIF_FEB,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202102'+'01'AS DATETIME))-1),CAST('202102'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120)))) END) FEBRERO,
J.MARZO		 DIAS_MARZO		   , ISNULL(T.DIF_MAR,0) DIF_MAR, (CASE WHEN (J.MARZO		- ISNULL(T.DIF_MAR,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202103'+'01'AS DATETIME))-1),CAST('202103'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.MARZO			- ISNULL(T.DIF_MAR,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202103'+'01'AS DATETIME))-1),CAST('202103'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120)))) END) MARZO,
J.ABRIL		 DIAS_ABRIL		   , ISNULL(T.DIF_ABR,0) DIF_ABR, (CASE WHEN (J.ABRIL		- ISNULL(T.DIF_ABR,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202104'+'01'AS DATETIME))-1),CAST('202104'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.ABRIL			- ISNULL(T.DIF_ABR,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202104'+'01'AS DATETIME))-1),CAST('202104'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120)))) END) ABRIL,
J.MAYO		 DIAS_MAYO		   , ISNULL(T.DIF_MAY,0) DIF_MAY, (CASE WHEN (J.MAYO		- ISNULL(T.DIF_MAY,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202105'+'01'AS DATETIME))-1),CAST('202105'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.MAYO			- ISNULL(T.DIF_MAY,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202105'+'01'AS DATETIME))-1),CAST('202105'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120)))) END) MAYO,
J.JUNIO		 DIAS_JUNIO		   , ISNULL(T.DIF_JUN,0) DIF_JUN, (CASE WHEN (J.JUNIO		- ISNULL(T.DIF_JUN,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202106'+'01'AS DATETIME))-1),CAST('202106'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.JUNIO			- ISNULL(T.DIF_JUN,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202106'+'01'AS DATETIME))-1),CAST('202106'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120)))) END) JUNIO,
J.JULIO		 DIAS_JULIO		   , ISNULL(T.DIF_JUL,0) DIF_JUL, (CASE WHEN (J.JULIO		- ISNULL(T.DIF_JUL,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202107'+'01'AS DATETIME))-1),CAST('202107'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.JULIO			- ISNULL(T.DIF_JUL,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202107'+'01'AS DATETIME))-1),CAST('202107'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120)))) END) JULIO,
J.AGOSTO	 DIAS_AGOSTO	   , ISNULL(T.DIF_AGO,0) DIF_AGO, (CASE WHEN (J.AGOSTO		- ISNULL(T.DIF_AGO,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202108'+'01'AS DATETIME))-1),CAST('202108'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.AGOSTO		- ISNULL(T.DIF_AGO,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202108'+'01'AS DATETIME))-1),CAST('202108'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120)))) END) AGOSTO,
J.SEPTIEMBRE DIAS_SEPTIEMBRE   , ISNULL(T.DIF_SEP,0) DIF_SEP, (CASE WHEN (J.SEPTIEMBRE	- ISNULL(T.DIF_SEP,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202109'+'01'AS DATETIME))-1),CAST('202109'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.SEPTIEMBRE	- ISNULL(T.DIF_SEP,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202109'+'01'AS DATETIME))-1),CAST('202109'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120)))) END) SEPTIEMBRE,
J.OCTUBRE	 DIAS_OCTUBRE	   , ISNULL(T.DIF_OCT,0) DIF_OCT, (CASE WHEN (J.OCTUBRE		- ISNULL(T.DIF_OCT,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202110'+'01'AS DATETIME))-1),CAST('202110'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.OCTUBRE		- ISNULL(T.DIF_OCT,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202110'+'01'AS DATETIME))-1),CAST('202110'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120)))) END) OCTUBRE,
J.NOVIEMBRE	 DIAS_NOVIEMBRE	   , ISNULL(T.DIF_NOV,0) DIF_NOV, (CASE WHEN (J.NOVIEMBRE	- ISNULL(T.DIF_NOV,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202111'+'01'AS DATETIME))-1),CAST('202111'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.NOVIEMBRE		- ISNULL(T.DIF_NOV,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202111'+'01'AS DATETIME))-1),CAST('202111'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120)))) END) NOVIEMBRE,
J.DICIEMBRE	 DIAS_DICIEMBRE	   , ISNULL(T.DIF_DIC,0) DIF_DIC, (CASE WHEN (J.DICIEMBRE	- ISNULL(T.DIF_DIC,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202112'+'01'AS DATETIME))-1),CAST('202112'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120)))) < 0 THEN 0 ELSE (J.DICIEMBRE		- ISNULL(T.DIF_DIC,0)- dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202112'+'01'AS DATETIME))-1),CAST('202112'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120)))) END) DICIEMBRE

FROM (				  

SELECT *,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  1 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  1 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202101') END) ELSE 0 END) ELSE 0 END) ENERO,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  2 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  2 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202102') END) ELSE 0 END) ELSE 0 END) FEBRERO,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  3 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  3 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202103') END) ELSE 0 END) ELSE 0 END) MARZO,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  4 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  4 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202104') END) ELSE 0 END) ELSE 0 END) ABRIL,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  5 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  5 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202105') END) ELSE 0 END) ELSE 0 END) MAYO,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  6 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  6 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202106') END) ELSE 0 END) ELSE 0 END) JUNIO,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  7 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  7 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202107') END) ELSE 0 END) ELSE 0 END) JULIO,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  8 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  8 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202108') END) ELSE 0 END) ELSE 0 END) AGOSTO,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  9 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  9 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202109') END) ELSE 0 END) ELSE 0 END) SEPTIEMBRE,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <= 10 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) = 10 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202110') END) ELSE 0 END) ELSE 0 END) OCTUBRE,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <= 11 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) = 11 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202111') END) ELSE 0 END) ELSE 0 END) NOVIEMBRE,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <= 12 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) = 12 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202112') END) ELSE 0 END) ELSE 0 END) DICIEMBRE

FROM (

SELECT DNI, NOMBRE, FINGRESO FINGRESO_ORIG, 
(CASE WHEN DATEDIFF(YEAR,FINGRESO,'2021-12-31') > 0 THEN '2021-01-01' ELSE FINGRESO END) FINGRESO,  CESE --, (CASE WHEN DATEDIFF(YEAR,FINGRESO,'2021-12-31') > 0 THEN '2021-01-01' ELSE FINGRESO END) ANIO,
FROM (
select LTRIM(RTRIM(perid)) DNI, (LTRIM(RTRIM(perpaterno))+' '+LTRIM(RTRIM(permaterno))+', '+LTRIM(RTRIM(pernombre))) NOMBRE, perfing FINGRESO, 
ISNULL(perfend,'1900-01-01') CESE from personal where perfing <= '2021-01-01' and perstatus <> 'R' and perid not in (select perid from personal where year(perfend) = '2021')

) x --WHERE DNI in ('44195967')

) Z

) J

LEFT JOIN 
(
SELECT * FROM (
SELECT DNI, --NOMBRE, FINGRESO, --CESE, 

ISNULL(([202101]-(ABS([202101]/7))),0) DIF_ENE,
ISNULL(([202102]-(ABS([202102]/7))),0) DIF_FEB,
ISNULL(([202103]-(ABS([202103]/7))),0) DIF_MAR,
ISNULL(([202104]-(ABS([202104]/7))),0) DIF_ABR,
ISNULL(([202105]-(ABS([202105]/7))),0) DIF_MAY,
ISNULL(([202106]-(ABS([202106]/7))),0) DIF_JUN,
ISNULL(([202107]-(ABS([202107]/7))),0) DIF_JUL,
ISNULL(([202108]-(ABS([202108]/7))),0) DIF_AGO,
ISNULL(([202109]-(ABS([202109]/7))),0) DIF_SEP,
ISNULL(([202110]-(ABS([202110]/7))),0) DIF_OCT,
ISNULL(([202111]-(ABS([202111]/7))),0) DIF_NOV,
ISNULL(([202112]-(ABS([202112]/7))),0) DIF_DIC

FROM  
(

SELECT A.DNI, A.NOMBRE, A.FINGRESO, --A.CESE, 
SUM(B.DIAS) DIAS, B.PERPOST
FROM PERSONAL_UTILIDADES A
LEFT JOIN personal_mensual B ON A.DNI = B.dni
WHERE B.codigo IN ('01','05','07','12','20','21','23','26','28','32') --AND A.DNI IN ('43608369','72130767')
GROUP BY A.DNI, A.NOMBRE, B.PERPOST, A.FINGRESO


) AS DATA 
PIVOT  
(  
SUM(DIAS)  
FOR PERPOST IN ([202101], [202102], [202103], [202104], [202105],[202106],[202107],[202108],[202109],[202110],[202111],[202112])  
) AS PIVOTE
) X --WHERE [202101]>31 OR [202102]>31 OR [202103]>31 OR [202104]>31 OR [202105]>31 OR[202106]>31 OR[202107]>31 OR[202108]>31 OR[202109]>31 OR[202110]>31 OR[202111]>31 OR[202112]>31
--WHERE DNI = '44195967'
) T ON J.DNI = T.DNI


UNION ALL


--PERSONAL CON INGRESO EN EL AÑO 2021

SELECT J.DNI, NOMBRE, --FINGRESO, 
FINGRESO_ORIG, CESE,

J.ENERO		 DIAS_ENERO		   , ISNULL(T.DIF_ENE,0) DIF_ENE, (CASE WHEN (J.ENERO		- ISNULL(T.DIF_ENE,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  1 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202101'+'01'AS DATETIME))-1),CAST('202101'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.ENERO		- ISNULL(T.DIF_ENE,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  1 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202101'+'01'AS DATETIME))-1),CAST('202101'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120))) END)) END) ENERO,
J.FEBRERO	 DIAS_FEBRERO	   , ISNULL(T.DIF_FEB,0) DIF_FEB, (CASE WHEN (J.FEBRERO		- ISNULL(T.DIF_FEB,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  2 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202102'+'01'AS DATETIME))-1),CAST('202102'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.FEBRERO	- ISNULL(T.DIF_FEB,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  2 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202102'+'01'AS DATETIME))-1),CAST('202102'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120))) END)) END) FEBRERO,
J.MARZO		 DIAS_MARZO		   , ISNULL(T.DIF_MAR,0) DIF_MAR, (CASE WHEN (J.MARZO		- ISNULL(T.DIF_MAR,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  3 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202103'+'01'AS DATETIME))-1),CAST('202103'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.MARZO		- ISNULL(T.DIF_MAR,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  3 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202103'+'01'AS DATETIME))-1),CAST('202103'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120))) END)) END) MARZO,
J.ABRIL		 DIAS_ABRIL		   , ISNULL(T.DIF_ABR,0) DIF_ABR, (CASE WHEN (J.ABRIL		- ISNULL(T.DIF_ABR,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  4 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202104'+'01'AS DATETIME))-1),CAST('202104'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.ABRIL		- ISNULL(T.DIF_ABR,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  4 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202104'+'01'AS DATETIME))-1),CAST('202104'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120))) END)) END) ABRIL,
J.MAYO		 DIAS_MAYO		   , ISNULL(T.DIF_MAY,0) DIF_MAY, (CASE WHEN (J.MAYO		- ISNULL(T.DIF_MAY,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  5 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202105'+'01'AS DATETIME))-1),CAST('202105'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.MAYO		- ISNULL(T.DIF_MAY,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  5 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202105'+'01'AS DATETIME))-1),CAST('202105'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120))) END)) END) MAYO,
J.JUNIO		 DIAS_JUNIO		   , ISNULL(T.DIF_JUN,0) DIF_JUN, (CASE WHEN (J.JUNIO		- ISNULL(T.DIF_JUN,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  6 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202106'+'01'AS DATETIME))-1),CAST('202106'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.JUNIO		- ISNULL(T.DIF_JUN,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  6 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202106'+'01'AS DATETIME))-1),CAST('202106'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120))) END)) END) JUNIO,
J.JULIO		 DIAS_JULIO		   , ISNULL(T.DIF_JUL,0) DIF_JUL, (CASE WHEN (J.JULIO		- ISNULL(T.DIF_JUL,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  7 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202107'+'01'AS DATETIME))-1),CAST('202107'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.JULIO		- ISNULL(T.DIF_JUL,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  7 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202107'+'01'AS DATETIME))-1),CAST('202107'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120))) END)) END) JULIO,
J.AGOSTO	 DIAS_AGOSTO	   , ISNULL(T.DIF_AGO,0) DIF_AGO, (CASE WHEN (J.AGOSTO		- ISNULL(T.DIF_AGO,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  8 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202108'+'01'AS DATETIME))-1),CAST('202108'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.AGOSTO		- ISNULL(T.DIF_AGO,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  8 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202108'+'01'AS DATETIME))-1),CAST('202108'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120))) END)) END) AGOSTO,
J.SEPTIEMBRE DIAS_SEPTIEMBRE   , ISNULL(T.DIF_SEP,0) DIF_SEP, (CASE WHEN (J.SEPTIEMBRE	- ISNULL(T.DIF_SEP,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  9 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202109'+'01'AS DATETIME))-1),CAST('202109'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.SEPTIEMBRE	- ISNULL(T.DIF_SEP,0)- (CASE WHEN MONTH(FINGRESO_ORIG) =  9 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202109'+'01'AS DATETIME))-1),CAST('202109'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120))) END)) END) SEPTIEMBRE,
J.OCTUBRE	 DIAS_OCTUBRE	   , ISNULL(T.DIF_OCT,0) DIF_OCT, (CASE WHEN (J.OCTUBRE		- ISNULL(T.DIF_OCT,0)- (CASE WHEN MONTH(FINGRESO_ORIG) = 10 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202110'+'01'AS DATETIME))-1),CAST('202110'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.OCTUBRE	- ISNULL(T.DIF_OCT,0)- (CASE WHEN MONTH(FINGRESO_ORIG) = 10 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202110'+'01'AS DATETIME))-1),CAST('202110'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120))) END)) END) OCTUBRE,
J.NOVIEMBRE	 DIAS_NOVIEMBRE	   , ISNULL(T.DIF_NOV,0) DIF_NOV, (CASE WHEN (J.NOVIEMBRE	- ISNULL(T.DIF_NOV,0)- (CASE WHEN MONTH(FINGRESO_ORIG) = 11 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202111'+'01'AS DATETIME))-1),CAST('202111'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.NOVIEMBRE	- ISNULL(T.DIF_NOV,0)- (CASE WHEN MONTH(FINGRESO_ORIG) = 11 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202111'+'01'AS DATETIME))-1),CAST('202111'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120))) END)) END) NOVIEMBRE,
J.DICIEMBRE	 DIAS_DICIEMBRE	   , ISNULL(T.DIF_DIC,0) DIF_DIC, (CASE WHEN (J.DICIEMBRE	- ISNULL(T.DIF_DIC,0)- (CASE WHEN MONTH(FINGRESO_ORIG) = 12 AND YEAR(FINGRESO_ORIG) = 2021 THEN ABS(DATEDIFF(DAY,FINGRESO_ORIG,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO_ORIG))),DATEADD(mm,1,FINGRESO_ORIG)),120))/7) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202112'+'01'AS DATETIME))-1),CAST('202112'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120))) END)) < 0 THEN 0 ELSE (J.DICIEMBRE	- ISNULL(T.DIF_DIC,0)- (CASE WHEN MONTH(FINGRESO_ORIG) = 12 AND YEAR(FINGRESO_ORIG) = 2021 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202112'+'01'AS DATETIME))-1),CAST('202112'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120))) END)) END) DICIEMBRE


FROM (				  

SELECT *,
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  1 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  1 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202101') END) ELSE 0 END) ELSE 0 END) ENERO, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  2 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  2 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202102') END) ELSE 0 END) ELSE 0 END) FEBRERO, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  3 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  3 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202103') END) ELSE 0 END) ELSE 0 END) MARZO, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  4 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  4 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202104') END) ELSE 0 END) ELSE 0 END) ABRIL, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  5 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  5 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202105') END) ELSE 0 END) ELSE 0 END) MAYO, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  6 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  6 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202106') END) ELSE 0 END) ELSE 0 END) JUNIO, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  7 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  7 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202107') END) ELSE 0 END) ELSE 0 END) JULIO, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  8 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  8 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202108') END) ELSE 0 END) ELSE 0 END) AGOSTO, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <=  9 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) =  9 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202109') END) ELSE 0 END) ELSE 0 END) SEPTIEMBRE, --30
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <= 10 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) = 10 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202110') END) ELSE 0 END) ELSE 0 END) OCTUBRE, 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <= 11 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) = 11 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202111') END) ELSE 0 END) ELSE 0 END) NOVIEMBRE, --30 
(CASE WHEN FINGRESO < = '2021-12-31' THEN (CASE WHEN MONTH(FINGRESO) <= 12 AND YEAR(FINGRESO) <= 2021 THEN (CASE WHEN MONTH(FINGRESO) = 12 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),120)) + 1 ELSE dbo.devolver_diasmes('202112') END) ELSE 0 END) ELSE 0 END) DICIEMBRE

FROM (

SELECT DNI, NOMBRE, FINGRESO FINGRESO_ORIG, 
(CASE WHEN DATEDIFF(YEAR,FINGRESO,'2021-12-31') > 0 THEN '2021-01-01' ELSE FINGRESO END) FINGRESO,  CESE --, (CASE WHEN DATEDIFF(YEAR,FINGRESO,'2021-12-31') > 0 THEN '2021-01-01' ELSE FINGRESO END) ANIO,
FROM (

select LTRIM(RTRIM(perid)) DNI, (LTRIM(RTRIM(perpaterno))+' '+LTRIM(RTRIM(permaterno))+', '+LTRIM(RTRIM(pernombre))) NOMBRE, perfing FINGRESO, 
ISNULL(perfend,'1900-01-01') CESE from personal where year(perfing) = '2021' --and perstatus <> 'R'
and perid not in (select perid from personal where year(perfend) = '2021')
--AND perid = '44291021'

) x --WHERE MONTH(FINGRESO) = 12 --in ('40572017')

) Z

) J

LEFT JOIN 
(
SELECT * FROM (
SELECT DNI, --NOMBRE, FINGRESO, --CESE, 

ISNULL(([202101]-(ABS([202101]/7))),0) DIF_ENE,
ISNULL(([202102]-(ABS([202102]/7))),0) DIF_FEB,
ISNULL(([202103]-(ABS([202103]/7))),0) DIF_MAR,
ISNULL(([202104]-(ABS([202104]/7))),0) DIF_ABR,
ISNULL(([202105]-(ABS([202105]/7))),0) DIF_MAY,
ISNULL(([202106]-(ABS([202106]/7))),0) DIF_JUN,
ISNULL(([202107]-(ABS([202107]/7))),0) DIF_JUL,
ISNULL(([202108]-(ABS([202108]/7))),0) DIF_AGO,
ISNULL(([202109]-(ABS([202109]/7))),0) DIF_SEP,
ISNULL(([202110]-(ABS([202110]/7))),0) DIF_OCT,
ISNULL(([202111]-(ABS([202111]/7))),0) DIF_NOV,
ISNULL(([202112]-(ABS([202112]/7))),0) DIF_DIC

FROM  
(

SELECT A.DNI, A.NOMBRE, A.FINGRESO, --A.CESE, 
SUM(B.DIAS) DIAS, B.PERPOST
FROM PERSONAL_UTILIDADES A
LEFT JOIN personal_mensual B ON A.DNI = B.dni
WHERE B.codigo IN ('01','05','07','12','20','21','23','26','28','32') --AND A.DNI IN ('05640925')
GROUP BY A.DNI, A.NOMBRE, B.PERPOST, A.FINGRESO

) AS DATA 
PIVOT  
(  
SUM(DIAS)  
FOR PERPOST IN ([202101], [202102], [202103], [202104], [202105],[202106],[202107],[202108],[202109],[202110],[202111],[202112])  
) AS PIVOTE
) X --WHERE [202101]>31 OR [202102]>31 OR [202103]>31 OR [202104]>31 OR [202105]>31 OR[202106]>31 OR[202107]>31 OR[202108]>31 OR[202109]>31 OR[202110]>31 OR[202111]>31 OR[202112]>31
--WHERE DNI = '40572017'
) T ON J.DNI = T.DNI


UNION ALL


--- PARA CESADOS

SELECT J.DNI, NOMBRE, --FINGRESO, 
FINGRESO_ORIG,  CESE,


J.ENERO		 DIAS_ENERO		   , ISNULL(T.DIF_ENE,0) DIF_ENE, (CASE WHEN ((J.ENERO		 - ISNULL(T.DIF_ENE,0))- (CASE WHEN MONTH(CESE) =  1 AND MONTH(FINGRESO) =  1 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202101'+'01'AS DATETIME))-1),CAST('202101'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  1 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202101'+'01'AS DATETIME))-1),CAST('202101'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.ENERO		- ISNULL(T.DIF_ENE,0))-  (CASE WHEN MONTH(CESE) =  1 AND MONTH(FINGRESO) =  1 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202101'+'01'AS DATETIME))-1),CAST('202101'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  1 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  1 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202101'+'01'AS DATETIME))-1),CAST('202101'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202101'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202101'+'01'AS DATETIME))),120))) END) END) END) END)) END) ENERO,
J.FEBRERO	 DIAS_FEBRERO	   , ISNULL(T.DIF_FEB,0) DIF_FEB, (CASE WHEN ((J.FEBRERO	 - ISNULL(T.DIF_FEB,0))- (CASE WHEN MONTH(CESE) =  2 AND MONTH(FINGRESO) =  2 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202102'+'01'AS DATETIME))-1),CAST('202102'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  2 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202102'+'01'AS DATETIME))-1),CAST('202102'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.FEBRERO		- ISNULL(T.DIF_FEB,0))-  (CASE WHEN MONTH(CESE) =  2 AND MONTH(FINGRESO) =  2 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202102'+'01'AS DATETIME))-1),CAST('202102'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  2 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  2 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202102'+'01'AS DATETIME))-1),CAST('202102'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202102'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202102'+'01'AS DATETIME))),120))) END) END) END) END)) END) FEBRERO,
J.MARZO		 DIAS_MARZO		   , ISNULL(T.DIF_MAR,0) DIF_MAR, (CASE WHEN ((J.MARZO		 - ISNULL(T.DIF_MAR,0))- (CASE WHEN MONTH(CESE) =  3 AND MONTH(FINGRESO) =  3 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202103'+'01'AS DATETIME))-1),CAST('202103'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  3 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202103'+'01'AS DATETIME))-1),CAST('202103'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.MARZO		- ISNULL(T.DIF_MAR,0))-  (CASE WHEN MONTH(CESE) =  3 AND MONTH(FINGRESO) =  3 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202103'+'01'AS DATETIME))-1),CAST('202103'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  3 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  3 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202103'+'01'AS DATETIME))-1),CAST('202103'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202103'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202103'+'01'AS DATETIME))),120))) END) END) END) END)) END) MARZO,
J.ABRIL		 DIAS_ABRIL		   , ISNULL(T.DIF_ABR,0) DIF_ABR, (CASE WHEN ((J.ABRIL		 - ISNULL(T.DIF_ABR,0))- (CASE WHEN MONTH(CESE) =  4 AND MONTH(FINGRESO) =  4 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202104'+'01'AS DATETIME))-1),CAST('202104'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  4 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202104'+'01'AS DATETIME))-1),CAST('202104'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.ABRIL		- ISNULL(T.DIF_ABR,0))-  (CASE WHEN MONTH(CESE) =  4 AND MONTH(FINGRESO) =  4 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202104'+'01'AS DATETIME))-1),CAST('202104'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  4 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  4 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202104'+'01'AS DATETIME))-1),CAST('202104'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202104'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202104'+'01'AS DATETIME))),120))) END) END) END) END)) END) ABRIL,
J.MAYO		 DIAS_MAYO		   , ISNULL(T.DIF_MAY,0) DIF_MAY, (CASE WHEN ((J.MAYO		 - ISNULL(T.DIF_MAY,0))- (CASE WHEN MONTH(CESE) =  5 AND MONTH(FINGRESO) =  5 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202105'+'01'AS DATETIME))-1),CAST('202105'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  5 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202105'+'01'AS DATETIME))-1),CAST('202105'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.MAYO			- ISNULL(T.DIF_MAY,0))-  (CASE WHEN MONTH(CESE) =  5 AND MONTH(FINGRESO) =  5 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202105'+'01'AS DATETIME))-1),CAST('202105'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  5 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  5 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202105'+'01'AS DATETIME))-1),CAST('202105'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202105'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202105'+'01'AS DATETIME))),120))) END) END) END) END)) END) MAYO,
J.JUNIO		 DIAS_JUNIO		   , ISNULL(T.DIF_JUN,0) DIF_JUN, (CASE WHEN ((J.JUNIO		 - ISNULL(T.DIF_JUN,0))- (CASE WHEN MONTH(CESE) =  6 AND MONTH(FINGRESO) =  6 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202106'+'01'AS DATETIME))-1),CAST('202106'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  6 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202106'+'01'AS DATETIME))-1),CAST('202106'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.JUNIO		- ISNULL(T.DIF_JUN,0))-  (CASE WHEN MONTH(CESE) =  6 AND MONTH(FINGRESO) =  6 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202106'+'01'AS DATETIME))-1),CAST('202106'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  6 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  6 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202106'+'01'AS DATETIME))-1),CAST('202106'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202106'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202106'+'01'AS DATETIME))),120))) END) END) END) END)) END) JUNIO,
J.JULIO		 DIAS_JULIO		   , ISNULL(T.DIF_JUL,0) DIF_JUL, (CASE WHEN ((J.JULIO		 - ISNULL(T.DIF_JUL,0))- (CASE WHEN MONTH(CESE) =  7 AND MONTH(FINGRESO) =  7 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202107'+'01'AS DATETIME))-1),CAST('202107'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  7 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202107'+'01'AS DATETIME))-1),CAST('202107'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.JULIO		- ISNULL(T.DIF_JUL,0))-  (CASE WHEN MONTH(CESE) =  7 AND MONTH(FINGRESO) =  7 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202107'+'01'AS DATETIME))-1),CAST('202107'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  7 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  7 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202107'+'01'AS DATETIME))-1),CAST('202107'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202107'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202107'+'01'AS DATETIME))),120))) END) END) END) END)) END) JULIO,
J.AGOSTO	 DIAS_AGOSTO	   , ISNULL(T.DIF_AGO,0) DIF_AGO, (CASE WHEN ((J.AGOSTO		 - ISNULL(T.DIF_AGO,0))- (CASE WHEN MONTH(CESE) =  8 AND MONTH(FINGRESO) =  8 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202108'+'01'AS DATETIME))-1),CAST('202108'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  8 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202108'+'01'AS DATETIME))-1),CAST('202108'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.AGOSTO		- ISNULL(T.DIF_AGO,0))-  (CASE WHEN MONTH(CESE) =  8 AND MONTH(FINGRESO) =  8 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202108'+'01'AS DATETIME))-1),CAST('202108'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  8 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  8 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202108'+'01'AS DATETIME))-1),CAST('202108'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202108'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202108'+'01'AS DATETIME))),120))) END) END) END) END)) END) AGOSTO,
J.SEPTIEMBRE DIAS_SEPTIEMBRE   , ISNULL(T.DIF_SEP,0) DIF_SEP, (CASE WHEN ((J.SEPTIEMBRE  - ISNULL(T.DIF_SEP,0))- (CASE WHEN MONTH(CESE) =  9 AND MONTH(FINGRESO) =  9 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202109'+'01'AS DATETIME))-1),CAST('202109'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  9 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202109'+'01'AS DATETIME))-1),CAST('202109'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.SEPTIEMBRE	- ISNULL(T.DIF_SEP,0))-  (CASE WHEN MONTH(CESE) =  9 AND MONTH(FINGRESO) =  9 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202109'+'01'AS DATETIME))-1),CAST('202109'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) =  9 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) =  9 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202109'+'01'AS DATETIME))-1),CAST('202109'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202109'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202109'+'01'AS DATETIME))),120))) END) END) END) END)) END) SEPTIEMBRE,
J.OCTUBRE	 DIAS_OCTUBRE	   , ISNULL(T.DIF_OCT,0) DIF_OCT, (CASE WHEN ((J.OCTUBRE	 - ISNULL(T.DIF_OCT,0))- (CASE WHEN MONTH(CESE) = 10 AND MONTH(FINGRESO) = 10 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202110'+'01'AS DATETIME))-1),CAST('202110'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) = 10 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202110'+'01'AS DATETIME))-1),CAST('202110'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.OCTUBRE		- ISNULL(T.DIF_OCT,0))-  (CASE WHEN MONTH(CESE) = 10 AND MONTH(FINGRESO) = 10 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202110'+'01'AS DATETIME))-1),CAST('202110'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) = 10 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) = 10 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202110'+'01'AS DATETIME))-1),CAST('202110'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202110'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202110'+'01'AS DATETIME))),120))) END) END) END) END)) END) OCTUBRE,
J.NOVIEMBRE	 DIAS_NOVIEMBRE	   , ISNULL(T.DIF_NOV,0) DIF_NOV, (CASE WHEN ((J.NOVIEMBRE	 - ISNULL(T.DIF_NOV,0))- (CASE WHEN MONTH(CESE) = 11 AND MONTH(FINGRESO) = 11 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202111'+'01'AS DATETIME))-1),CAST('202111'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) = 11 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202111'+'01'AS DATETIME))-1),CAST('202111'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.NOVIEMBRE	- ISNULL(T.DIF_NOV,0))-  (CASE WHEN MONTH(CESE) = 11 AND MONTH(FINGRESO) = 11 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202111'+'01'AS DATETIME))-1),CAST('202111'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) = 11 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) = 11 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202111'+'01'AS DATETIME))-1),CAST('202111'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202111'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202111'+'01'AS DATETIME))),120))) END) END) END) END)) END) NOVIEMBRE,
J.DICIEMBRE	 DIAS_DICIEMBRE	   , ISNULL(T.DIF_DIC,0) DIF_DIC, (CASE WHEN ((J.DICIEMBRE	 - ISNULL(T.DIF_DIC,0))- (CASE WHEN MONTH(CESE) = 12 AND MONTH(FINGRESO) = 12 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202112'+'01'AS DATETIME))-1),CAST('202112'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) = 12 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202112'+'01'AS DATETIME))-1),CAST('202112'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120))) END) END) END)) < 0 THEN 0 ELSE ((J.DICIEMBRE	- ISNULL(T.DIF_DIC,0))-  (CASE WHEN MONTH(CESE) = 12 AND MONTH(FINGRESO) = 12 AND FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) AND CESE = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CESE))),DATEADD(mm,1,CESE)),120) THEN dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202112'+'01'AS DATETIME))-1),CAST('202112'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120))) ELSE (CASE WHEN MONTH(FINGRESO) = MONTH(CESE) THEN dbo.devolver_domingos(FINGRESO,CESE) ELSE (CASE WHEN MONTH(CESE) = 12 THEN dbo.devolver_domingos(CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(CESE)-1),CESE),101),CESE) ELSE (CASE WHEN YEAR(FINGRESO_ORIG) = '2021' AND MONTH(FINGRESO_ORIG) = 12 THEN dbo.devolver_domingos(FINGRESO_ORIG,(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120))) ELSE dbo.devolver_domingos((CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CAST('202112'+'01'AS DATETIME))-1),CAST('202112'+'01'AS DATETIME)),120)),(CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(DATEADD(mm,1,CAST('202112'+'01'AS DATETIME)))),DATEADD(mm,1,CAST('202112'+'01'AS DATETIME))),120))) END) END) END) END)) END) DICIEMBRE

FROM (		  

SELECT *,

(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  1 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  1 AND MONTH(FINGRESO) =  1 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  1 THEN (CASE WHEN MONTH(FINGRESO) <=  1 THEN (CASE WHEN MONTH(FINGRESO) =  1 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202101') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) ENERO, 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  2 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  2 AND MONTH(FINGRESO) =  2 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  2 THEN (CASE WHEN MONTH(FINGRESO) <=  2 THEN (CASE WHEN MONTH(FINGRESO) =  2 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202102') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) FEBRERO, 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  3 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  3 AND MONTH(FINGRESO) =  3 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  3 THEN (CASE WHEN MONTH(FINGRESO) <=  3 THEN (CASE WHEN MONTH(FINGRESO) =  3 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202103') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) MARZO, 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  4 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  4 AND MONTH(FINGRESO) =  4 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  4 THEN (CASE WHEN MONTH(FINGRESO) <=  4 THEN (CASE WHEN MONTH(FINGRESO) =  4 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202104') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) ABRIL, 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  5 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  5 AND MONTH(FINGRESO) =  5 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  5 THEN (CASE WHEN MONTH(FINGRESO) <=  5 THEN (CASE WHEN MONTH(FINGRESO) =  5 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202105') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) MAYO, 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  6 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  6 AND MONTH(FINGRESO) =  6 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  6 THEN (CASE WHEN MONTH(FINGRESO) <=  6 THEN (CASE WHEN MONTH(FINGRESO) =  6 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202106') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) JUNIO, 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  7 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  7 AND MONTH(FINGRESO) =  7 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  7 THEN (CASE WHEN MONTH(FINGRESO) <=  7 THEN (CASE WHEN MONTH(FINGRESO) =  7 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202107') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) JULIO, 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  8 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  8 AND MONTH(FINGRESO) =  8 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  8 THEN (CASE WHEN MONTH(FINGRESO) <=  8 THEN (CASE WHEN MONTH(FINGRESO) =  8 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202108') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) AGOSTO, 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) =  9 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) =  9 AND MONTH(FINGRESO) =  9 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >=  9 THEN (CASE WHEN MONTH(FINGRESO) <=  9 THEN (CASE WHEN MONTH(FINGRESO) =  9 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202109') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) SEPTIEMBRE, --30
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) = 10 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) = 10 AND MONTH(FINGRESO) = 10 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >= 10 THEN (CASE WHEN MONTH(FINGRESO) <= 10 THEN (CASE WHEN MONTH(FINGRESO) = 10 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202110') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) OCTUBRE, --31
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) = 11 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) = 11 AND MONTH(FINGRESO) = 11 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >= 11 THEN (CASE WHEN MONTH(FINGRESO) <= 11 THEN (CASE WHEN MONTH(FINGRESO) = 11 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202111') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) NOVIEMBRE, --30 
(CASE WHEN CESE < = '2021-12-31' THEN (CASE WHEN MONTH(CESE) = 12 AND YEAR(CESE) = 2021 THEN (CASE WHEN MONTH(CESE) = 12 AND MONTH(FINGRESO) = 12 THEN (CASE WHEN FINGRESO = CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(FINGRESO)-1),FINGRESO),120) THEN DATEDIFF(DAY,FINGRESO,CESE)+1 ELSE DATEDIFF(DAY,FINGRESO,CESE)+1 END) ELSE (CASE WHEN FINGRESO < CESE THEN DATEDIFF(DAY,CONVERT(VARCHAR(10),DATEADD(dd,-(DAY(CESE)-1),CESE),120),CESE)+1 ELSE 0 END) END) ELSE (CASE WHEN MONTH(CESE) >= 12 THEN (CASE WHEN MONTH(FINGRESO) <= 12 THEN (CASE WHEN MONTH(FINGRESO) = 12 THEN DATEDIFF(DAY,FINGRESO,CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(DATEADD(mm,1,FINGRESO))),DATEADD(mm,1,FINGRESO)),101))+1 ELSE dbo.devolver_diasmes('202112') END) ELSE 0 END) ELSE 0 END) END) ELSE 0 END) DICIEMBRE

FROM (

SELECT DNI, NOMBRE, FINGRESO FINGRESO_ORIG, 
(CASE WHEN DATEDIFF(YEAR,FINGRESO,'2021-12-31') > 0 OR DNI = '46563840' THEN '2021-01-01' ELSE FINGRESO END) FINGRESO,  CESE --, (CASE WHEN DATEDIFF(YEAR,FINGRESO,'2021-12-31') > 0 THEN '2021-01-01' ELSE FINGRESO END) ANIO,
FROM (

select LTRIM(RTRIM(perid)) DNI, (LTRIM(RTRIM(perpaterno))+' '+LTRIM(RTRIM(permaterno))+', '+LTRIM(RTRIM(pernombre))) NOMBRE, perfing FINGRESO, 
ISNULL(perfend,'1900-01-01') CESE from personal where year(perfend) = '2021' --and perstatus <> 'R'
--and perid in ('70069937')
) x --WHERE DNI = '40572017'

) Z --WHERE MONTH(CESE) = 11 -- = '45818910'

) J

LEFT JOIN 

(
SELECT * FROM (
SELECT DNI, --NOMBRE, FINGRESO, --CESE, 

ISNULL(([202101]-(ABS([202101]/7))),0) DIF_ENE,
ISNULL(([202102]-(ABS([202102]/7))),0) DIF_FEB,
ISNULL(([202103]-(ABS([202103]/7))),0) DIF_MAR,
ISNULL(([202104]-(ABS([202104]/7))),0) DIF_ABR,
ISNULL(([202105]-(ABS([202105]/7))),0) DIF_MAY,
ISNULL(([202106]-(ABS([202106]/7))),0) DIF_JUN,
ISNULL(([202107]-(ABS([202107]/7))),0) DIF_JUL,
ISNULL(([202108]-(ABS([202108]/7))),0) DIF_AGO,
ISNULL(([202109]-(ABS([202109]/7))),0) DIF_SEP,
ISNULL(([202110]-(ABS([202110]/7))),0) DIF_OCT,
ISNULL(([202111]-(ABS([202111]/7))),0) DIF_NOV,
ISNULL(([202112]-(ABS([202112]/7))),0) DIF_DIC

FROM  
(

SELECT A.DNI, A.NOMBRE, A.FINGRESO, --A.CESE, 
SUM(B.DIAS) DIAS, B.PERPOST
FROM PERSONAL_UTILIDADES A
LEFT JOIN personal_mensual B ON A.DNI = B.dni
WHERE B.codigo IN ('01','05','07','12','20','21','23','26','28','32') --AND A.DNI IN ('43608369','72130767')
GROUP BY A.DNI, A.NOMBRE, B.PERPOST, A.FINGRESO

-- SELECT * FROM motivo_labores

) AS DATA 
PIVOT  
(  
SUM(DIAS)  
FOR PERPOST IN ([202101], [202102], [202103], [202104], [202105],[202106],[202107],[202108],[202109],[202110],[202111],[202112])  
) AS PIVOTE
) X --WHERE [202101]>31 OR [202102]>31 OR [202103]>31 OR [202104]>31 OR [202105]>31 OR[202106]>31 OR[202107]>31 OR[202108]>31 OR[202109]>31 OR[202110]>31 OR[202111]>31 OR[202112]>31
--WHERE DNI = '40572017'

) T ON J.DNI = T.DNI

) M

WHERE M.DNI NOT IN ('40033352','42706489','72174102','72388324','45047812','45002217','72895775')

ORDER BY NOMBRE ASC


--SELECT DNI, PERPOST, SUM(dias) DIAS FROM personal_mensual WHERE CODIGO = '23'
--GROUP BY DNI, PERPOST


--SELECT DNI, SUM(dias) DIAS 
--FROM personal_mensual WHERE CODIGO = '23' AND DNI = '45123196'
--GROUP BY DNI

--SELECT DNI, SUM(dias) DIAS 
--FROM personal_mensual WHERE CODIGO = '23' AND DNI = '72130767'
--GROUP BY DNI


--sp_helptext 'dbo.devolver_domingos'
--sp_helptext 'dbo.devolver_diasmes'

--select dbo.devolver_diasmes('202102')
